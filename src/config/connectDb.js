const mongoose = require('mongoose');
require('dotenv').config();
require('colors');

// Cache connection across requests
let cachedConnection = null;
let cachedConnectionPromise = null;

const connectDB = async () => {
  if (!process.env.MONGO_URI) {
    throw new Error('MONGO_URI environment variable is not set');
  }

  // Already connected — reuse
  if (cachedConnection && mongoose.connection.readyState === 1) {
    return cachedConnection;
  }

  // Connection in progress — wait for it
  if (cachedConnectionPromise) {
    return cachedConnectionPromise;
  }

  cachedConnectionPromise = mongoose.connect(process.env.MONGO_URI, {
    connectTimeoutMS: 30000,
    socketTimeoutMS: 45000,
    serverSelectionTimeoutMS: 30000,
    bufferCommands: true,
    bufferTimeoutMS: 30000,   // must be >= serverSelectionTimeoutMS
    maxPoolSize: 10,
    minPoolSize: 1,
    family: 4,                // force IPv4 — avoids IPv6 resolution issues on Render
  });

  try {
    const conn = await cachedConnectionPromise;
    cachedConnection = conn;
    cachedConnectionPromise = null;
    console.log(`✅ MongoDB connected: ${mongoose.connection.host}`.green.bold);
    return conn;
  } catch (error) {
    cachedConnectionPromise = null;
    cachedConnection = null;
    console.error('❌ MongoDB connection failed:'.red.bold, error.message);
    throw error;
  }
};

module.exports = { connectDB };
